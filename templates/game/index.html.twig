{% extends 'base.html.twig' %}

{% block title %}Catalogue - GameVault{% endblock %}

{% block body %}
    <div class="page-header">
        <h1 class="page-header__title">{{ query ? 'R√©sultats pour "' ~ query ~ '"' : 'Jeux populaires' }}</h1>
    </div>

    <form method="get" action="{{ path('app_game_index') }}" class="filter-bar">
        <div class="filter-bar__form">
            <div class="filter-bar__field filter-bar__search">
                <input type="text" name="q" value="{{ query }}" placeholder="Rechercher un jeu..." class="form-input">
            </div>
            <div class="filter-bar__field">
                <select name="genre" class="form-select">
                    <option value="">Tous les genres</option>
                    {% for g in genres %}
                        <option value="{{ g }}"{% if genre == g %} selected{% endif %}>{{ g }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="filter-bar__field">
                <select name="platform" class="form-select">
                    <option value="">Toutes les plateformes</option>
                    {% for p in platforms %}
                        <option value="{{ p }}"{% if platform == p %} selected{% endif %}>{{ p }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="filter-bar__actions">
                <button type="submit" class="btn btn--primary btn--sm">Filtrer</button>
                {% if query or genre or platform %}
                    <a href="{{ path('app_game_index') }}" class="btn btn--outline btn--sm">Reset</a>
                {% endif %}
            </div>
        </div>
    </form>

    {% if error %}
        <div class="flash flash--danger">{{ error }}</div>
    {% endif %}

    {% if (query or genre or platform) and results|length == 0 and not error %}
        <div class="empty-state">
            <div class="empty-state__icon">üîç</div>
            <h3 class="empty-state__title">Aucun r√©sultat</h3>
            <p class="empty-state__text">Essayez de modifier vos filtres.</p>
        </div>
    {% endif %}

    {% if results|length > 0 %}
        <div class="grid grid--4">
            {% for game in results %}
                <div class="game-card">
                    <a href="{{ path('app_game_show', {igdbId: game.igdbId}) }}">
                        {% if game.coverUrl %}
                            <img src="{{ game.coverUrl }}" alt="{{ game.name }}" class="game-card__image">
                        {% else %}
                            <div class="game-card__placeholder">üéÆ</div>
                        {% endif %}
                    </a>
                    <div class="game-card__body">
                        <h3 class="game-card__title">
                            <a href="{{ path('app_game_show', {igdbId: game.igdbId}) }}">{{ game.name }}</a>
                        </h3>
                        <div class="game-card__meta">
                            <span class="game-card__tag">{{ game.platform }}</span>
                            <span class="game-card__tag">{{ game.genre }}</span>
                        </div>
                        {% if is_granted('ROLE_USER') %}
                            <div class="game-card__actions">
                                {% if alreadyInCollection[game.igdbId] is defined %}
                                    <span class="btn btn--outline btn--sm" style="opacity: 0.5; cursor: default;">Dans ma collection</span>
                                {% else %}
                                    <form method="post" action="{{ path('app_igdb_add', {igdbId: game.igdbId}) }}">
                                        <input type="hidden" name="_token" value="{{ csrf_token('igdb_add_' ~ game.igdbId) }}">
                                        <button type="submit" class="btn btn--primary btn--sm">+ Collection</button>
                                    </form>
                                {% endif %}
                            </div>
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
        </div>
    {% endif %}
{% endblock %}
